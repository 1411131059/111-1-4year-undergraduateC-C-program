#include <stdio.h>

struct student
{
    unsigned int StuNum;
    char Name[20];
    int math, com;
    double average;
};

typedef struct student StuData;
void bubble(StuData* stuArr, int num);

int main(void)
{
    FILE* cfPtr;
    unsigned int i;

    if ((cfPtr = fopen("accounts.dat", "rb+")) == NULL)
    {
        puts("File could not be opened.");
    }
    else
    {
        StuData student = { 0,"",0,0,0.0 }, blankStu = { 0,"",0,0,0.0 };
        for (i = 1; i <= 100; ++i)
        {
            fwrite(&blankStu, sizeof(StuData), 1, cfPtr);
        }

        printf("%s", "Enter student number""(1 to 100, 0 to end input): ");
        scanf("%d", &student.StuNum);

        while (student.StuNum != 0)
        {
            printf("%s", "Enter name, math, com: ");
            fscanf(stdin, "%14s%d%d", student.Name, &student.math, &student.com);
            student.average = (double)(student.math + student.com) / 2;
            fseek(cfPtr, (student.StuNum - 1) * sizeof(StuData), SEEK_SET);
            fwrite(&student, sizeof(StuData), 1, cfPtr);
            printf("%s", "\nEnter student number: ");
            scanf("%d", &student.StuNum);
        }
        fclose(cfPtr);
    }

    StuData stuArr[100];

    if ((cfPtr = fopen("accounts.dat", "rb")) == NULL)
    {
        puts("File could not be opened.");
    }
    else
    {
        printf("%-6s%-8s%-8s%-8s%6s\n", "Num", "Name", "Math", "Com", "Average");

        while (!feof(cfPtr))
        {
            StuData student = { 0,"",0,0,0.0 };

            int result = fread(&student, sizeof(StuData), 1, cfPtr);

            if (result != 0 && student.StuNum != 0)
            {
                printf("%-6u%-8s%-8d%-8d%-10.2f\n", student.StuNum, student.Name, student.math, student.com, student.average);
                stuArr[i].StuNum = student.StuNum;
                strcpy(stuArr[i].Name, student.Name);
                stuArr[i].math = student.math;
                stuArr[i].com = student.com;
                stuArr[i].average = student.average;
                i++;
            }
        }
        fclose(cfPtr);
    }
    for (int j = 0; j < i; j++)
    {
        printf("%-6u%-8s%-8d%-8d%-10.2f\n", stuArr[j].StuNum, stuArr[j].Name, stuArr[j].math, stuArr[j].com, stuArr[j].average);
    }
    bubble(stuArr, i);
    for (int j = 0; j < i; j++)
    {
        printf("%-6u%-8s%-8d%-8d%-10.2f\n", stuArr[j].StuNum, stuArr[j].Name, stuArr[j].math, stuArr[j].com, stuArr[j].average);
    }
}

void bubble(StuData* stuArr, int num)
{
    int hold, pass, i;
    for (pass = 1; pass < num; ++pass) {
        for (i = 0; i < num - pass; ++i) 
        {
            if (stuArr[i].average < stuArr[i + 1].average)
            {
                StuData temp;
                temp = stuArr[i];
                stuArr[i] = stuArr[i + 1];
                stuArr[i + 1] = temp;
            }
        }
    }
}
